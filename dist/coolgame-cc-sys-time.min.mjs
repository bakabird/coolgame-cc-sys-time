import{SysBase}from"coolgame-cc";import{FreeList}from"gnfun";var Private;!function(e){e.Timer=class{get interval(){return.001*this.intervalMS}get complete(){return 0===this.loopLeft}trigger(){return this.args&&0!==this.args.length||(this.args=[this.id]),this.method.apply(this.caller,this.args),this}}}(Private||(Private={}));class TimerModule{constructor(e){this._sys=e,this._everTimers=null,this._valid=!0,this._everTimers=[]}Dispose(){var e;null===(e=this._everTimers)||void 0===e||e.forEach(e=>{this._sys.delete(e)}),this._sys=null,this._valid=!1}delay(e,t,r,...i){return this._addTimer(e,1,t,r,...i)}nextframe(e,t,...r){return this._addTimer(0,1,e,t,...r)}_addTimer(e,t,r,i,...s){if(!this._valid)return void console.warn("module isnot valid cant add timer");const l=this._sys.timer(e,t,r,i,...s);return this._everTimers||(this._everTimers=[]),this._everTimers.push(l),l}}class TimeSys extends SysBase{constructor(){super(...arguments),this.sysName="TimeSys"}OnInit(e){this._nextGlobalID=1,this._pool=new Array,this._timers=new FreeList,e()}OnLateInit(e){e()}OnDispose(){this._pool=null,this._timers=null}update(e){const t=Date.now();this._timers.foreach_safe(e=>(e.loopLeft>0?e.latestTriggerTime+e.intervalMS<=t&&(e.latestTriggerTime=t,--e.loopLeft,e.trigger()):(this._gabage(e),this._timers.remove(e)),!0))}static get seconds(){return.001*Date.now()}timer(e,t,r,i,...s){return this._timer(e,t,r,i,s)}delay(e,t,r,...i){return this._timer(e,1,t,r,i)}frame(e,t,r,...i){return this._timer(0,e,t,r,i)}nextFrame(e,t,...r){return this._timer(0,1,e,t,r)}delete(e){if(null!=e&&e&&e>0){let t=this._timers.removeFirstIf(t=>t.id===e);t&&this._gabage(t)}}isTimerComplete(e){let t=this._getTimer(e);return!t||t.complete}getTimerInterval(e){let t=this._getTimer(e);return t?t.interval:-1}getTimerCallback(e){let t=this._getTimer(e);return t?t.method:void 0}getTimerThisObj(e){let t=this._getTimer(e);return t?t.caller:void 0}getTimerNextTriggerTime(e){let t=this._getTimer(e);return t?t.latestTriggerTime+t.interval:0}getTimerArgs(e){let t=this._getTimer(e);return t?t.args:void 0}triggerTimer(e){let t=this._getTimer(e);return t&&t.trigger(),e}generateModule(){return new TimerModule(this)}_getTimer(e){if(!(null==e||e||e<=0))return this._timers.findFirstIf(t=>t.id===e)}_timer(e,t,r,i,s){let l=this._pool.length>0?this._pool.pop():new Private.Timer;return l.id=this._nextGlobalID++,l.intervalMS=1e3*e,l.loopLeft=t<0?Number.MAX_VALUE:0===t?1:t,l.latestTriggerTime=Date.now(),s&&s.push(l.id),l.method=r,l.caller=i,l.args=s,this._timers.push(l),l.id}_gabage(e){e.method=void 0,e.caller=void 0,e.args=void 0,this._pool.push(e)}get timerCount(){return this._timers.length}}export{TimerModule,TimeSys as default};